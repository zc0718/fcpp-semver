name: Versioning

on:
  push:
    branches:
      - main  # 仅在 main 分支推送时触发

# 关键：必须授予 Action 写入仓库的权限，否则无法回装 commit
permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    # 防止多个 job 同时运行导致 Git 推送冲突
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # 关键：fetch-depth 必须为 0，否则脚本无法分析历史 commit 记录
          fetch-depth: 0
          # 使用 GITHUB_TOKEN 进行身份验证
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run Versioning Script
        # 指定脚本路径，并确保它有执行权限
        run: |
          chmod +x .github/scripts/commit_semver.py
          python3 .github/scripts/commit_semver.py

      - name: Push Changes
        # 脚本内已经完成了 git commit，这里只需将本地 commit 推送到远程
        run: |
          git push origin main